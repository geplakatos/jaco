<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>RemoteControll</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>

        <link href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAABXAAAAVwAAAFcAAABXAAAAV3M3WP9zN1j/czdY/3M3WP9zN1j/uEuH/wAAAFcAAABXAAAAVwAAAAAAAAAAAAAAAAAAAACKOmb/ijpm/4o6Zv+KOmb/ijpm/4o6Zv+KOmb/uEuH/7hLh5kAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACKOmb/ijpmjgAAAAAAAAAAijpm/4o6Zv+KOmb/ijpm/7hLh/8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAuEuH/wAAAAAAAAAAAAAAAIo6Zv+KOmb/ijpm/4o6Zv+KOmb/uEuHmQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALhLh/8AAAAAAAAAAAAAAACKOmaOijpm/4o6Zv+KOmb/ijpm/7hLh/8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAC4S4f/uEuHngAAAAAAAAAAAAAAAIo6Zv+KOmb/ijpm/4o6Zv+4S4f/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALhLh/+4S4f/AAAAAAAAAACKOmb/czdY/3M3WP9zN1j/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACKOmb/ijpm/3M3WP9zN1j/czdY/3M3WP9zN1hlAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIo6Zo6KOmb/ijpm/4o6Zv+KOmb/ijpm/4o6Zv+KOmb/ijpm/4o6Zv+4S4eZAAAAAAAAAAAAAAAAAAAAAMjV1TiKOmb/ijpm/2ska3VrJGs0HiAf/4o6Zv+KOmb/ijpm/4o6Zv+KOmb/uEuH/wAAAAAAAAAAAAAAAAAAAAC+yspAijpm/4o6Zv9rJGs0AAAAAB4gH/+KOmb/ayRrdWskazQeIB//ijpm/7hLh/8AAAAAAAAAAAAAAAAAAAAAAAAAAIo6Zv+KOmb/ayRrdWskazRrJGt1ijpm/2skazQAAAAAHiAf/4o6Zv+4S4f/AAAAAAAAAAAAAAAAAAAAAAAAAACKOmaOijpm/4o6Zv+KOmb/ijpm/4o6Zv9rJGt1ayRrNGska3W4S4f/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIo6Zv+KOmb/ijpm/4o6Zv+KOmb/ijpm/4o6Zv+KOmb/uEuHmQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAC4S4d3uEuH/4o6Zv+KOmaHxszMN4o6ZoeKOmb/uEuH/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALhLh/8AAAAAAAAAAAAAAAAAAAAAuEuH/wAAAAAAAAAAAAAAAAAAAAAAAAAA+B8AAMAfAACYPwAAuB8AALgfAACcHwAAzD8AAPgfAADgAwAA5gMAAOZjAADnYwAA4HcAAPAHAAD4jwAA+98AAA==" rel="icon" type="image/x-icon" />
        <style>
            body {
                margin: 0px;
                padding: 0px;
                width: 100%;
                height: 100%;
                position: fixed;
                overflow-y: hidden;

                -moz-user-select: none;
                -khtml-user-select: none;
                -webkit-user-select: none;
                user-select: none;                
            }

            #main {
                position: relative;
                width: 100%;
                height: 100%;
            }

            #connectstatus {
                position: absolute;
                bottom: 0px;
                right: 0px;
                font-size: 12px;
                line-height: 20px;
                opacity: 0.8;
                padding: 0 10px 0 10px;      
                color: black;
                cursor: pointer;
            }

            .connecting_status_0 {
                background-color: yellow;
            }
            .connecting_status_1 {
                background-color: green;
                color: white !important;
            }
            .connecting_status_2 {
                background-color: orange;
            }
            .connecting_status_3 {
                background-color: red;
                color: white !important;
            }

            .basebtn {
                color: white;                
                background-color: grey;
                position: absolute;
                width: 33.33%;
                height: 100px;
                top: 0px;
                text-align: center;
                line-height: 100px;       
                cursor: pointer;
            }

            #leftbtn {
                border-right: 1px solid white;
                left: 0px;                
            }

            #middlebtn {                
                left: 33.33%;
            }

            #rightbtn {
                border-left: 1px solid white;
                right: 0px;
            }

            #textinput {
                position: absolute;
                width: 100%;
                top: 100px;
                height: 30px;
                line-height: 30px;
                margin: 0px;
                padding: 0px;
                outline: 0px;
                border: 1px solid grey;
            }

            .wheel {
                position: absolute;
                width: 60px;
                font-size: 10px;
                text-align: center;
                top: 100px;                
                background-color: black;
                color: white;
                cursor: pointer;
            }

            .fullscreen {
                font-size:10px;
                position: absolute;
                width: 60px;
                height: 50px;
                text-align: center;
                bottom: 0px;                
                background-color: black;
                color: white;
                cursor: pointer;
                line-height: 50px;
                border-top: 1px solid white;
            }

            #movearea {
                position: absolute;
                left: 60px;
                top: 100px;
                height: 100%;                
                color: black;
                background-color: white;
                overflow: hidden;
                text-align: left !important;
            }

            #movearea p {
                padding: 0px;
                margin: 0px;
            }

            #wheelup {
                border-bottom: 1px solid white;                
            }

            #wheeldown {
                border-top: 1px solid white;
            }

            #wheeldown span {
                position: absolute;
                left: 0px;
                bottom: 5px;                                
            }

            #wheelup span {
                position: absolute;
                left: 0px;
                top: 5px;                                
            }

            .image {
                width: 100%;
                height: 100%;
                object-fit: contain;                
            }

            .movepanel, .logpanel {
                margin: 5px;
                position: absolute;
                left: 0px;
                top: 0px;
                width: 100%;
                height: 100%;
            }
        </style>
    </head>

    <body>
        <div id="connectpanel">
            <form id="doconnectform" style="padding:5px">
                <i><b>Connect to remote server</b></i>
                <br>                
                <br>                

                URL: <input type="text" id="connecturl" pattern=".{1,}"><br>
                Password: <input type="password" id="pwd" pattern=".{1,}"><br>                

                <input type="submit" id="doconnect" value="Connect">
            </form>
        </div>

        <div id="main" style="display:none">            
            <div id="middlebtn" class="basebtn">MIDDLE</div>
            <div id="leftbtn" class="basebtn">LEFT</div>            
            <div id="rightbtn" class="basebtn">RIGHT</div>            
            <!--<div contenteditable="true" id="textinput"></div>-->
            <div id="wheelup" class="wheel"><span>WHEEL UP</span></div>
            <div id="wheeldown" class="wheel"><span>WHEEL DOWN</span></div>
            <div id="fullscreen" class="fullscreen"><span>FS</span></div>
            <div id="movearea">
                <div class="logpanel"></div>
                <div class="movepanel"></div>
                <canvas id="can" class="image" width="400" height="400"></canvas>
                <div id="crosshair"></div>
            </div>            

            <div id="connectstatus"></div>
        </div>
        <script type="text/javascript">
            var html_status = jQuery("#main #connectstatus");
            var html_left = jQuery("#main #leftbtn");
            var html_middle = jQuery("#main #middlebtn");
            var html_right = jQuery("#main #rightbtn");
            var html_wheelup = jQuery("#main #wheelup");
            var html_wheeldown = jQuery("#main #wheeldown");
            var html_fullscreen = jQuery("#main #fullscreen");
            var html_move = jQuery("#main #movearea");
            var html_movepanel = html_move.find(".movepanel");
            var html_logpanel = html_move.find(".logpanel");
            var html_image = html_move.find(".image");
            //var html_type = jQuery("#main #textinput");
            var ws = 0;

            function getCharacterPrecedingCaret(containerEl) {
                var precedingChar = "", sel, range, precedingRange;
                if (window.getSelection) {
                    sel = window.getSelection();
                    if (sel.rangeCount > 0) {
                        range = sel.getRangeAt(0).cloneRange();
                        range.collapse(true);
                        range.setStart(containerEl, 0);
                        precedingChar = range.toString().slice(-1);
                    }
                } else if ((sel = document.selection) && sel.type != "Control") {
                    range = sel.createRange();
                    precedingRange = range.duplicate();
                    precedingRange.moveToElementText(containerEl);
                    precedingRange.setEndPoint("EndToStart", range);
                    precedingChar = precedingRange.text.slice(-1);
                }
                return precedingChar;
            }

            /*html_type.keyup(function () {
             setTimeout(function (t) {
             var t = getCharacterPrecedingCaret(html_type.get(0));
             if (t.length == 1) {
             ws.send({type: "keyup", code: t.charCodeAt(0)});
             }
             }, 10);
             });*/

            html_fullscreen.click(function () {
                var element = document.body;
                var requestMethod = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || element.msRequestFullScreen;
                requestMethod.call(element);
            });
            html_left.click(function () {
                ws.send({type: "leftclick"});
            });
            html_middle.click(function () {
                ws.send({type: "middleclick"});
            });
            html_right.click(function () {
                ws.send({type: "rightclick"});
            });
            html_wheelup.click(function () {
                ws.send({type: "wheelup"});
            });
            html_wheeldown.click(function () {
                ws.send({type: "wheeldown"});
            });
            html_status.click(function () {
                document.location.reload();
            });

            jQuery("#connectpanel #connecturl").val("ws://" + document.location.host + "/ws");
            jQuery("#connectpanel #pwd").val("");
            jQuery("#connectpanel #pwd").focus();

            jQuery("#connectpanel #doconnectform").submit(function () {
                try {
                    var element = document.body;
                    var requestMethod = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || element.msRequestFullScreen;
                    requestMethod.call(element);

                    jQuery("#connectpanel").hide();
                    jQuery("#main").show();
                    ws = connect();
                } catch (err) {
                    console.log(err);
                }
                return false;
            });

            if ("file:" == location.protocol) {
                jQuery("#connectpanel #connecturl").val("ws://127.0.0.1:8080/ws");
                jQuery("#connectpanel #pwd").val("alma");
                jQuery("#connectpanel #doconnectform").submit();
            }

            var pointerEventToXY = function (e) {
                var out = {x: 0, y: 0};
                if (e.type == 'touchstart' || e.type == 'touchmove' || e.type == 'touchend' || e.type == 'touchcancel') {
                    var touch = e.originalEvent.touches[0] || e.originalEvent.changedTouches[0];
                    out.x = touch.pageX;
                    out.y = touch.pageY;
                } else if (e.type == 'mousedown' || e.type == 'mouseup' || e.type == 'mousemove' || e.type == 'mouseover' || e.type == 'mouseout' || e.type == 'mouseenter' || e.type == 'mouseleave') {
                    out.x = e.pageX;
                    out.y = e.pageY;
                }
                out.x = Math.round(out.x);
                out.y = Math.round(out.y);
                return out;
            };

            var dragging = false;
            html_move.on('mousedown touchstart', function (event) {
                event = pointerEventToXY(event);
                dragging = {
                    x: event.x,
                    y: event.y,
                };
                log("Start dragging: x:" + dragging.x + " y:" + dragging.y);
            });

            jQuery(document).on('mousemove touchmove', function (event) {
                try {
                    if (dragging !== false) {
                        event = pointerEventToXY(event);
                        var x = event.x;
                        var y = event.y;

                        var dx = x - dragging.x;
                        var dy = y - dragging.y;

                        dragging.x = x;
                        dragging.y = y;

                        ws.send({type: "move", dx: dx, dy: dy}, false);
                    }
                } catch (err) {
                    console.log(err);
                }
            });

            jQuery(document).on('mouseup touchend', function (event) {
                if (dragging !== false) {
                    dragging = false;
                    ws.send({type: "mousescreenshot", w: 400, h: 400});
                    log("stop dragging");
                }
            });

            function resize() {
                var w = jQuery(window).width();
                var h = jQuery(window).height();
                var overh = html_left.height();// + html_type.outerHeight();
                var remainh = h - overh;
                html_move.width(w - html_wheelup.width());
                html_move.height(remainh);

                var wheelh = Math.round(remainh / 2) - html_fullscreen.height() / 2;

                html_wheelup.height(wheelh);
                html_wheeldown.height(wheelh);
                html_wheeldown.css("top", parseInt(html_wheelup.css("top").replace("px", "")) + wheelh);
                log("resize to: " + w + "x" + h);
            }

            jQuery(window).resize(function () {
                resize();
            });

            function log() {
                return;
                var t = "";
                for (var i = 0; i < arguments.length; i++) {
                    t += arguments[i] + " ";
                }
                var d = new Date();
                var hour = d.getHours();
                var minute = d.getMinutes();
                var second = d.getSeconds();
                var date = (hour < 10 ? "0" : "") + hour + ":" +
                        (minute < 10 ? "0" : "") + minute + ":" +
                        (second < 10 ? "0" : "") + second;
                var s = "<p>" + date + ": " + jQuery.trim(t) + "</p>";
                html_logpanel.prepend(s);
                html_logpanel.children().each(function (a, b) {
                    if (a > 40) {
                        jQuery(b).remove();
                    }
                })
            }

            resize();

            function connect() {
                var currid = Math.round(Math.random() * 1000);
                var ws = new WebSocket(jQuery("#connectpanel #connecturl").val(), "taviranyito__" + jQuery("#connectpanel #pwd").val());
                var ping = 0;
                var lastsend = 0;//Date.now();
                var senddelay = 500;

                function showState() {
                    var s = ws.readyState;
                    var t = "???";
                    var statuses = [
                        {text: "Connecting"},
                        {text: "Open"},
                        {text: "Closing"},
                        {text: "Closed"},
                    ];
                    for (var i = 0; i < statuses.length; i++) {
                        html_status.removeClass("connecting_status_" + i);
                    }
                    if (statuses[s]) {
                        t = statuses[s].text;
                        html_status.addClass("connecting_status_" + s);
                    }
                    html_status.html("Connect status: " + t + " (reload page)");
                }

                function send(data, logging) {
                    lastsend = Date.now();
                    var r = JSON.stringify(data);
                    if (logging === undefined || logging === true) {
                        log("Send: " + r);
                    }
                    ws.send(r);
                }

                function wrap(id, obj, fun, cb, showstate) {
                    obj[fun] = function () {
                        if (currid == id) {
                            if (showstate) {
                                showState();
                            }
                            return cb.apply(null, arguments)
                        }
                    }
                }

                wrap(currid, ws, "onmessage", function (msg) {
                    //console.log(msg, typeof msg.data)
                    if (msg && msg.data && typeof msg.data != "string") {
                        var urlCreator = window.URL || window.webkitURL;
                        var imageUrl = urlCreator.createObjectURL(msg.data);
                        var i = new Image();
                        (function (i) {
                            i.onload = function () {
                                var canvas = document.getElementById("can");
                                var ctx = canvas.getContext("2d");
                                var s = ctx.globalCompositeOperation;
                                ctx.clearRect(0, 0, canvas.width, canvas.height);
                                ctx.drawImage(i, 0, 0);
                                ctx.globalCompositeOperation = window.aaa || "exclusion";

                                ctx.strokeStyle = "red";
                                ctx.beginPath();
                                ctx.moveTo(canvas.width / 2 - 11, canvas.height / 2);
                                ctx.lineTo(canvas.width / 2 + 11, canvas.height / 2);
                                ctx.stroke();

                                ctx.beginPath();
                                ctx.moveTo(canvas.width / 2, canvas.height / 2 - 11);
                                ctx.lineTo(canvas.width / 2, canvas.height / 2 + 11);
                                ctx.stroke();

                                ctx.globalCompositeOperation = s;
                            }
                        })(i);
                        i.src = imageUrl;
                        //console.log(msg);
                    }
                });

                wrap(currid, ws, "onclose", function (e) {
                    log("close", e);
                    clearInterval(ping);
                }, true);

                wrap(currid, ws, "onopen", function () {
                    log("open");
                    ping = setInterval(function () {
                        if (Math.abs(Date.now() - lastsend) > senddelay) {
                            send({type: "mousescreenshot", w: 400, h: 400});
                        }
                    }, 100);
                }, true);

                wrap(currid, ws, "onerror", function (e) {
                    log("error", e);
                }, true);

                showState();

                return {
                    send: send
                };
            }

            /*ws = {
             send: function (t) {
             log("send", JSON.stringify(t))
             }
             }*/
        </script>
    </body>
</html>